#!/bin/sh
set -e 

PACKAGE=mosh

case "$1" in
  build)
    if [ \! -f configure ]; then
      ./autogen.sh
    fi
    NCURSES_INCLUDE=${HOME}/droid/$BASEDIR/include/ncurses/
    export OPENSSL_CFLAGS=-I${HOME}/droid/$BASEDIR/include/openssl/
    export OPENSSL_LIBS="-lssl -lcrypto"
    export NCURSES_LIBS="-L$NCURSES_INCLUDE -lncurses"
    export USE_STATIC_GNUSTL=1
    ./configure --host=arm-linux --prefix=/$BASEDIR \
      CC=agcc CXX=ag++ CXXCPP="ag++ -E" \
      CPPFLAGS="-I$NCURSES_INCLUDE" \
      PKG_CONFIG_PATH=$HOME/droid/$BASEDIR/lib/pkgconfig/

    # -lpthread comes from the cross-compiling machine's library requirements
    # -lutil is needed for forkpty on the cross-compiling machine
    # -fPIE/-pie breaks android's dynamic linker
    sed -i -e 's/^protobuf_LIBS = -lprotobuf -lz -lpthread/protobuf_LIBS = -lprotobuf -lz/' \
      -e 's/^mosh_server_LDADD = $(LDADD) -lutil/mosh_server_LDADD = $(LDADD)/' \
      -e 's/^mosh_LDADD = $(LDADD) -lutil/mosh_LDADD = $(LDADD)/' \
      -e 's/^\(HARDEN_CFLAGS = .*\)-fPIE\(.*\)/\1 \2/' \
      -e 's/^\(HARDEN_LDFLAGS = .*\)-pie\(.*\)/\1 \2/' \
      src/frontend/Makefile
    make
    ;;

  install)
    DESTDIR=~/tmp/$PACKAGE
    rm -rf $DESTDIR
    mkdir -p $DESTDIR
    make install DESTDIR=$DESTDIR
    install -m755 src/frontend/mosh $DESTDIR/$BASEDIR/bin/
    astrip $DESTDIR/$BASEDIR/bin/mosh-client
    ;;
    
  clean)
    make clean
    ;;

  *)
    echo unknown argument $1
    ;;
esac
